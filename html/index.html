<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANVT Dashboard | Local Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div class="max-w-7xl mx-auto px-4 py-10">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">ANVT Events Manager</h1>
                <p id="api-status" class="text-sm text-slate-500 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
                    Connecting to http://localhost:8000...
                </p>
            </div>
            <div class="flex items-center gap-2">
                <button id="syncBtn" onclick="fetchEvents()" class="flex items-center gap-2 bg-white border px-4 py-2 rounded-lg shadow-sm hover:bg-slate-50 transition">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Sync Data
                </button>
                <div id="forceSyncMsg" class="hidden text-green-600 text-xs font-semibold ml-4">Force sync complete!</div>
            </div>
        </header>

        <div id="eventGrid">
            <div class="col-span-full flex flex-col items-center py-20 text-slate-400" id="loadingEvents">
                <div class="animate-spin mb-4"><i data-lucide="loader-2" class="w-10 h-10"></i></div>
                <p>Fetching events from your backend...</p>
            </div>
            <div id="todaySection" class="mb-10">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-bold">Evenement van vandaag</h2>
                    <button onclick="toggleSection('today')" id="toggleToday" class="text-xs text-blue-600 underline">Verbergen</button>
                </div>
                <div id="todayEvents" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            <div id="futureSection" class="mb-10">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-bold">Komende evenementen</h2>
                    <button onclick="toggleSection('future')" id="toggleFuture" class="text-xs text-blue-600 underline">Verbergen</button>
                </div>
                <div id="futureEvents" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            <div id="pastSection">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-bold">Oude evenementen</h2>
                    <button onclick="toggleSection('past')" id="togglePast" class="text-xs text-blue-600 underline">Verbergen</button>
                </div>
                <div id="pastEvents" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </div>


    <script>
                // Visual confirmation for force sync
                function showForceSyncMsg() {
                    const msg = document.getElementById('forceSyncMsg');
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.add('hidden'), 2000);
                }

                // Confirm before force sync
                async function confirmAndForceSync() {
                    const proceed = confirm('Are you sure you want to force sync? This will refresh all events from the backend.');
                    if (!proceed) return false;
                    return true;
                }

                // Hidden force sync: Ctrl+Shift+R (desktop)
                document.addEventListener('keydown', async (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'r') {
                        if (await confirmAndForceSync()) {
                            document.getElementById('api-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span> Force syncing...`;
                            try {
                                await fetch('http://localhost:8000/events/refresh', { method: 'POST' });
                                showForceSyncMsg();
                            } catch {}
                            fetchEvents();
                        }
                    }
                });

                // Hidden force sync: long-press on Sync Data button (mobile)
                let forceSyncTimeout;
                const syncBtn = document.getElementById('syncBtn');
                syncBtn.addEventListener('touchstart', function() {
                    forceSyncTimeout = setTimeout(async () => {
                        if (await confirmAndForceSync()) {
                            document.getElementById('api-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span> Force syncing...`;
                            try {
                                await fetch('http://localhost:8000/events/refresh', { method: 'POST' });
                                showForceSyncMsg();
                            } catch {}
                            fetchEvents();
                        }
                    }, 2000); // 2 seconds long-press
                });
                syncBtn.addEventListener('touchend', function() {
                    clearTimeout(forceSyncTimeout);
                });
        const API_URL = 'http://localhost:8000/events';
        let allEvents = [];

        // 1. Fetch Data from Backend
        async function fetchEvents() {
            const statusText = document.getElementById('api-status');
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Backend unreachable');

                allEvents = await response.json();
                renderEvents(allEvents);

                statusText.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Connected to Backend`;
            } catch (err) {
                statusText.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> Error: ${err.message}`;
                document.getElementById('eventGrid').innerHTML = `<div class="col-span-full text-center py-20 text-red-500 font-medium border-2 border-dashed rounded-2xl">Make sure your backend is running at localhost:8000</div>`;
            }
        }

        // 2. Render Cards to Grid
        function renderEvents(events) {
            document.getElementById('loadingEvents').style.display = 'none';
            // Clear all sections
            document.getElementById('futureEvents').innerHTML = '';
            document.getElementById('todayEvents').innerHTML = '';
            document.getElementById('pastEvents').innerHTML = '';

            const todayStr = new Date().toISOString().split('T')[0];
            const future = [];
            const today = [];
            const past = [];

            events.forEach(event => {
                const dateOnly = event.start ? event.start.split('T')[0] : '';
                if (dateOnly > todayStr) {
                    future.push({...event, _dateOnly: dateOnly});
                } else if (dateOnly === todayStr) {
                    today.push(event);
                } else {
                    past.push(event);
                }
            });
            // Sort future events by date ascending
            future.sort((a, b) => a._dateOnly.localeCompare(b._dateOnly));

            const renderCard = (event, faded = false) => {
                const dateOnly = event.start ? event.start.split('T')[0] : '';
                let nietLedenBar = '';
                if (!(event.niet_leden_sold_tickets == 0 && event.niet_leden_num_tickets == 0)) {
                    nietLedenBar = renderProgress('Vrijrijders', event.niet_leden_sold_tickets, event.niet_leden_num_tickets, 'bg-indigo-400');
                }
                return `
                <div class="bg-white rounded-2xl border border-slate-200 p-6 hover:shadow-xl transition-all group ${faded ? 'opacity-70' : ''}">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-900 leading-tight">${event.name}</h3>
                        <button onclick="goToOverview(${event.id})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">
                            <i data-lucide="info" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="text-xs text-slate-500 mb-4">${dateOnly}</div>
                    <div class="space-y-4">
                        ${renderProgress('Leden', event.leden_sold_tickets, event.leden_num_tickets, 'bg-blue-500')}
                        ${nietLedenBar}
                    </div>
                </div>`;
            };

        // Go to overview page for event participations
        function goToOverview(eventId) {
            window.location.href = `participations_overview.html?event_id=${eventId}`;
        }


            // Show/hide sections based on content
            const futureSection = document.getElementById('futureSection');
            const todaySection = document.getElementById('todaySection');
            const pastSection = document.getElementById('pastSection');

            document.getElementById('futureEvents').innerHTML = future.map(e => renderCard(e)).join('');
            document.getElementById('todayEvents').innerHTML = today.map(e => renderCard(e)).join('');
            document.getElementById('pastEvents').innerHTML = past.map(e => renderCard(e, true)).join('');

            futureSection.style.display = future.length ? '' : 'none';
            todaySection.style.display = today.length ? '' : 'none';
            pastSection.style.display = past.length ? '' : 'none';

            lucide.createIcons();
        }

        // Go to overview page for event participations
        function goToOverview(eventId) {
            window.location.href = `participations_overview.html?event_id=${eventId}`;
        }

        function toggleSection(section) {
            const sectionDiv = document.getElementById(section + 'Events');
            const btn = document.getElementById('toggle' + section.charAt(0).toUpperCase() + section.slice(1));
            if (sectionDiv.style.display === 'none') {
                sectionDiv.style.display = '';
                btn.textContent = 'Verbergen';
            } else {
                sectionDiv.style.display = 'none';
                btn.textContent = 'Tonen';
            }
        }

        function renderProgress(label, sold, total, color) {
            let pct, barColor;
            if (label === 'Vrijrijders' && (!total || total === 0) && (!sold || sold === 0)) {
                pct = 100;
                barColor = 'bg-red-500';
            } else if (!total || total === 0) {
                pct = 100;
                barColor = 'bg-green-500';
            } else {
                pct = Math.min(100, (sold / total) * 100);
                barColor = color;
            }
            return `
                <div>
                    <div class="flex justify-between text-[11px] font-bold text-slate-400 uppercase mb-1">
                        <span>${label}</span>
                        <span class="text-slate-700">${sold} / ${total || 'âˆž'}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                        <div class="${barColor} h-full transition-all duration-1000" style="width: ${pct}%"></div>
                    </div>
                </div>`;
        }


        // Initial Load
        fetchEvents();
    </script>
</body>
</html>