---
name: PR Checks (Parallel + Summary)

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write # Required to post the summary comment
  statuses: write # Required for Super-Linter
  security-events: write # Required for Trivy

jobs:
  # ------------------------------------------------------------------
  # JOB 1: LINTING
  # ------------------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile

      - name: Run Superlinter
        uses: super-linter/super-linter@v8.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ENV: false
          VALIDATE_GO: false
          VALIDATE_JSCPD: false
          VALIDATE_PYTHON_BLACK: false
          VALIDATE_PYTHON_RUFF_FORMAT: false
          VALIDATE_TRIVY: false
          VALIDATE_GITHUB_ACTIONS_ZIZMOR: false
          FIX_HTML_PRETTIER: true
          FIX_MARKDOWN_PRETTIER: true
          FIX_YAML_PRETTIER: true

  # ------------------------------------------------------------------
  # JOB 2: MALWARE SCAN (Source Code)
  # ------------------------------------------------------------------
  clamav_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ClamAV Scan
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav clamav-daemon
          sudo systemctl stop clamav-freshclam

          echo "Updating ClamAV Database..."
          if sudo freshclam; then
              echo "Database updated successfully."
          else
              echo "WARNING: Freshclam failed. Skipping scan to avoid blocking pipeline."
              exit 0
          fi

          echo "Running ClamAV Scan on Source Code..."
          if clamscan -r . \
            --exclude-dir=.git \
            --infected; then
              echo "ClamAV: No malware found."
          else
              echo "ClamAV: MALWARE FOUND!"
              exit 1
          fi

  # ------------------------------------------------------------------
  # JOB 3: BUILD, SCAN & TEST
  # ------------------------------------------------------------------
  build_test_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Load
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: test-image:local
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Dockle (Container Compliance)
        env:
          DOCKLE_VERSION: 0.4.14
        run: |
          BASE_URL="https://github.com/goodwithtech/dockle/releases/download"
          FILE_NAME="dockle_${DOCKLE_VERSION}_Linux-64bit.tar.gz"
          wget -q "${BASE_URL}/v${DOCKLE_VERSION}/${FILE_NAME}"
          tar zxvf "${FILE_NAME}"
          chmod +x dockle
          sudo mv dockle /usr/local/bin/
          rm "${FILE_NAME}"

          dockle --exit-code 1 \
            --exit-level WARN \
            -i CIS-DI-0001 \
            -i DKL-LI-0003 \
            test-image:local

      - name: Run Integration Test
        run: |
          docker run -d --name test-container test-image:local bash -c "sleep 60"
          sleep 2
          if ! docker ps | grep -q test-container; then
            echo "Container exited unexpectedly!"
            docker logs test-container
            exit 1
          fi
          docker exec test-container bash --version
          # docker exec test-container jq --version

  # ------------------------------------------------------------------
  # JOB 4: PR SUMMARY (The Fan-In)
  # ------------------------------------------------------------------
  pr_summary:
    runs-on: ubuntu-latest
    needs: [lint, clamav_scan, build_test_scan]
    if: always() # Run even if previous jobs failed
    steps:
      - name: Post Summary
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Map results to Emojis
            const results = {
              lint: '${{ needs.lint.result }}',
              clamav: '${{ needs.clamav_scan.result }}',
              build: '${{ needs.build_test_scan.result }}'
            };

            const getIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'skipped') return 'â­ï¸';
              return 'âš ï¸'; // cancelled or other
            };

            // 2. Build Markdown Message
            const summary = `
            ### ğŸ¤– Pipeline Results
            | Job | Status |
            | :--- | :---: |
            | **Linting** | ${getIcon(results.lint)} |
            | **Malware Scan** | ${getIcon(results.clamav)} |
            | **Build & Security** | ${getIcon(results.build)} |

            *See the "Checks" tab for detailed logs.*
            `;

            // 3. Post Comment to PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
